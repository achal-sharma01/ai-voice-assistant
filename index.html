<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Astra ‚Äì ESB + Dashboard Tiles</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b1220;color:#e5e7eb}
  .wrap{max-width:680px;margin:0 auto;padding:18px}
  .card{background:#0f172a;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}
  h1{margin:0 0 6px;font-size:20px}
  .muted{color:#94a3b8;font-size:13px;margin:0 0 12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:6px 10px;font-size:12px;color:#94a3b8}

  .mic{display:block;width:120px;height:120px;margin:12px auto;border-radius:50%;border:none;
       background:radial-gradient(60% 60% at 50% 30%,rgba(14,165,233,.25),transparent);
       box-shadow:inset 0 0 0 2px rgba(14,165,233,.35),0 10px 30px rgba(14,165,233,.25);
       font-size:34px;color:#fff}
  .mic.live{box-shadow:inset 0 0 0 3px rgba(34,197,94,.6),0 10px 30px rgba(34,197,94,.35)}
  .status{display:flex;gap:8px;justify-content:center;color:#94a3b8;font-size:13px}
  .dot{width:10px;height:10px;border-radius:50%;background:#ef4444}.dot.ok{background:#22c55e}

  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .tile{background:#0b1220;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
  .tile h3{margin:0 0 6px;font-size:12px;color:#94a3b8}
  .tile p{margin:0;font-size:18px}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .btn{border:1px solid rgba(255,255,255,.2);background:#0b1220;color:#e5e7eb;border-radius:10px;padding:10px 12px}

  .log{height:220px;overflow:auto;background:#0b1220;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;margin-top:12px}
  .log p{margin:6px 0;font-size:13px}
</style>
</head>
<body>
  <audio id="ttsAudio" preload="auto"></audio>
<div class="wrap">
  <div class="card">
    <h1>ü§ñ Astra ‚Äî Emergency Stable Build + Dashboard</h1>
    <p class="muted">Always-on listening with TTS-mute (no feedback loop). Voice commands, manual controls, report, and live tiles (Temp, Humidity, People, Light, Fan, Commands).</p>

    <div class="row">
      <span class="pill">Mode: <b>Always-on</b></span>
      <span class="pill">Lang: <b>en-IN</b></span>
      <span class="pill">Simulator: <b>ON</b></span>
    </div>

    <button id="micBtn" class="mic" title="Start/Stop">üé§</button>
    <div class="status"><span id="dot" class="dot"></span><span id="status">Idle</span></div>

    <!-- ‚¨áÔ∏è NEW DASHBOARD TILES -->
    <div class="kpis">
      <div class="tile"><h3>Light</h3><p id="kLight">OFF</p></div>
      <div class="tile"><h3>Fan</h3><p id="kFan">OFF</p></div>
      <div class="tile"><h3>People</h3><p id="kPeople">1</p></div>
      <div class="tile"><h3>Temp (¬∞C)</h3><p id="kTemp">27.0</p></div>
      <div class="tile"><h3>Humidity (%)</h3><p id="kHum">48.0</p></div>
      <div class="tile"><h3>Commands</h3><p id="kCmds">0</p></div>
    </div>

    <!-- Manual controls you already had -->
    <div class="grid">
      <button class="btn" id="btnLightOn">Light ON</button>
      <button class="btn" id="btnLightOff">Light OFF</button>
      <button class="btn" id="btnFanOn">Fan ON</button>
      <button class="btn" id="btnFanOff">Fan OFF</button>
      <button class="btn" id="btnReport">Speak Report</button>
      <button class="btn" id="btnReset">Reset Counters</button>
    </div>

    <div id="log" class="log" aria-live="polite"></div>
    <p class="muted">Say: ‚Äúturn the light on‚Äù, ‚Äúturn off the fan‚Äù, ‚Äúwhat‚Äôs the time‚Äù, ‚Äútemperature‚Äù, ‚Äúhumidity‚Äù, ‚Äúpeople‚Äù, ‚Äúreport‚Äù, ‚Äústop‚Äù.</p>
  </div>
</div>
  <script>
/* === ASTRA ‚Äî Human-like assistant (full conversational, stable) === */
/* Features: continuous listening, natural female voice, thinking pause,
   small talk, jokes, quick math, warm phrasing, manual controls, dashboard */

let listening=false, rec=null, ttsActive=false, lastProcessed="";
const logBox=document.getElementById('log'), dot=document.getElementById('dot'),
      statusEl=document.getElementById('status'), micBtn=document.getElementById('micBtn');

const counters={cmds:0, light_on_events:0, fan_on_events:0, light_ms:0, fan_ms:0, people_entries:0};
let cache={light:0, fan:0, temp:27.0, hum:48.0, people:1};
let _lightOnAt=null, _fanOnAt=null;
const LIGHT_WATTS=12, FAN_WATTS=75, INR_PER_KWH=8;

const kLight=document.getElementById('kLight'),
      kFan  =document.getElementById('kFan'),
      kPeople=document.getElementById('kPeople'),
      kTemp =document.getElementById('kTemp'),
      kHum  =document.getElementById('kHum'),
      kCmds =document.getElementById('kCmds');

function refreshTiles(){
  kLight.textContent = cache.light? "ON":"OFF";
  kFan.textContent   = cache.fan?   "ON":"OFF";
  kPeople.textContent= cache.people;
  kTemp.textContent  = cache.temp.toFixed(1);
  kHum.textContent   = cache.hum.toFixed(1);
  kCmds.textContent  = counters.cmds;
}

function setStatus(t,ok){ statusEl.textContent=t; dot.classList.toggle('ok', !!ok); }
function log(t){ const p=document.createElement('p'); p.textContent=t; logBox.appendChild(p); logBox.scrollTop=logBox.scrollHeight; }

/* ---------- Voice: pick best human-like female on Chrome Android ---------- */
let preferredVoice=null;
function pickBestVoice(){
  const voices=window.speechSynthesis.getVoices()||[];
  if(!voices.length) return null;
  const wantNames=[
    "Google UK English Female",
    "Google US English",
    "Google US English Female",
    "Microsoft Zira Desktop - English (United States)"
  ];
  return voices.find(v=>wantNames.includes(v.name))
      || voices.find(v=>/Google/i.test(v.name)&&/English/i.test(v.lang))
      || voices[0];
}
function initVoice(){ preferredVoice=pickBestVoice(); }
speechSynthesis.onvoiceschanged=()=>{ initVoice(); };
// Fallback in case Chrome doesn‚Äôt fire voiceschanged
setTimeout(()=>{ try{ initVoice(); }catch{} }, 400);

/* ---------- Humanize + tiny ‚Äúthinking‚Äù pause ---------- */
function humanize(text){
  let s = (text||"")
    .replace(/\bis not\b/gi,"isn't")
    .replace(/\bI am\b/gi,"I'm")
    .replace(/\bdo not\b/gi,"don't")
    .replace(/\bwe will\b/gi,"we'll");
  s = s.replace(/, /g,", ‚Ä¶ ");
  return s;
}
function thinkPause(){ return new Promise(res=>{ setStatus("Thinking‚Ä¶",false); setTimeout(res, 300+Math.random()*500); }); }

/* ---------- Speak (TTS-mute + barge-in) ---------- */
async function speak(text){
  // Safety: if something is already speaking, ignore new speech (prevents 'silent' bug)
  if (ttsActive) return;

  await thinkPause();

  // Stop any queued utterances cleanly
  try { if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel(); } catch {}

  ttsActive = true;
  try { rec && rec.stop(); } catch {}

  const u = new SpeechSynthesisUtterance(humanize(text));

  // Pick a solid voice
  const all = speechSynthesis.getVoices() || [];
  const want = ["Google UK English Female","Google US English","Google US English Female","Microsoft Zira Desktop - English (United States)"];
  const best = all.find(v => want.includes(v.name)) || (typeof preferredVoice !== "undefined" ? preferredVoice : null) || all[0];

  if (best) { u.voice = best; u.lang = best.lang; } else { u.lang = 'en-IN'; }
  u.rate = 0.97; u.pitch = 1.04; u.volume = 1.0;

  u.onstart = () => { setStatus("Speaking‚Ä¶", false); };
  u.onend   = () => {
    ttsActive = false;
    setStatus("Listening‚Ä¶", true);
    // small cooldown so STT doesn't collide
    setTimeout(()=>{ if(listening && rec){ try{ rec.start(); }catch{} } }, 250);
  };
  u.onerror = (e) => {
    ttsActive = false;
    log("TTS error: " + (e.error || 'unknown'));
    setStatus("Listening‚Ä¶", true);
    try { if (listening && rec) rec.start(); } catch {}
  };

  log("Astra: " + u.text);

  // Chrome quirk: speak after a short tick
  setTimeout(() => {
    try { speechSynthesis.resume(); } catch {}
    speechSynthesis.speak(u);
  }, 20);
}
/* ---------- Simulator (keep tiles alive until hardware plugs in) ---------- */
setInterval(()=>{
  cache.temp=Math.max(20,Math.min(35,cache.temp+(Math.random()*0.4-0.2)));
  cache.hum =Math.max(30,Math.min(70,cache.hum +(Math.random()*0.8-0.4)));
  if(Math.random()<0.25){
    const before=cache.people;
    cache.people=Math.max(0,before+(Math.random()<0.5?-1:1));
    if(cache.people>before) counters.people_entries+=(cache.people-before);
  }
  refreshTiles();
},1200);

/* ---------- Energy helpers ---------- */
const nowMs=()=>performance.now(), kwh=(ms,w)=>(ms/3600000)*(w/1000);
function startRun(what){const t=nowMs(); if(what==='light'&&_lightOnAt==null)_lightOnAt=t; if(what==='fan'&&_fanOnAt==null)_fanOnAt=t;}
function finishRun(what){const t=nowMs(); if(what==='light'&&_lightOnAt!=null){counters.light_ms+=t-_lightOnAt;_lightOnAt=null;} if(what==='fan'&&_fanOnAt!=null){counters.fan_ms+=t-_fanOnAt;_fanOnAt=null;}}
const fmtMs=ms=>{const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000); return (h?`${h}h `:"")+`${m}m`;};
function usage(){ const t=nowMs(); const lms=counters.light_ms+(_lightOnAt? t-_lightOnAt:0); const fms=counters.fan_ms+(_fanOnAt? t-_fanOnAt:0);
  const lk=kwh(lms,LIGHT_WATTS), fk=kwh(fms,FAN_WATTS), tk=lk+fk, cost=tk*INR_PER_KWH; return {lms,fms,lk,fk,tk,cost}; }

/* ---------- Brain: memory + small talk + math + intents ---------- */
const MEM=[]; // last few turns
function remember(user, astra){ MEM.push({user,astra}); if(MEM.length>8) MEM.shift(); }
const JOKES=[
 "Why did the computer get cold? It forgot to close its Windows.",
 "Why do programmers prefer dark mode? Because light attracts bugs.",
 "Parallel lines have so much in common‚Ä¶ it‚Äôs a shame they‚Äôll never meet."
];
const FACTS=[
 "Honey never spoils ‚Äî even after thousands of years.",
 "Octopuses have three hearts and blue blood.",
 "Bananas are berries, but strawberries aren‚Äôt.",
 "Your phone has more computing power than Apollo‚Äôs Apollo Guidance Computer."
];
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function tryMath(s){
  if(!/\b(what is|calculate|calc|evaluate)\b/i.test(s)) return null;
  const expr=s.replace(/.*?\b(what is|calculate|calc|evaluate)\s*/i,'').replace(/[^0-9+\-*/().\s]/g,'').trim();
  if(!expr) return "Tell me the equation you want me to solve.";
  try{ const val=Function(`"use strict";return(${expr})`)(); if(isFinite(val)) return `The answer is ${val}.`; }catch{}
  return "Hmm, I couldn't compute that one.";
}
function naturalReply(s){
  const last = MEM.length ? MEM[MEM.length-1].user : "";
  const soft = ["Sure.","Got it.","Okay.","Alright.","Happy to help."];
  if(last && Math.random()<0.35) return `${pick(soft)} About "${last}", I kept that in mind.`;
  return pick(soft)+" "+s;
}
function intent(text){
  let s=(text||"").toLowerCase().replace(/[^\p{L}\p{N}\s]/gu," ").replace(/\s+/g," ").trim();
  if(!s) return {type:"idle"};
  const has=w=>s.includes(w), any=(...a)=>a.some(w=>has(w));

  // Small talk
  if(any("how are you","how r u","how are u")) return {type:"say", text: pick([
    "I'm feeling great and ready to help. How are you?",
    "All good here ‚Äî calm, focused, and listening.",
    "Doing well! Thanks for asking."
  ])};
  if(any("your name","who are you")) return {type:"say", text:"I'm Astra ‚Äî your friendly room assistant."};
  if(any("what can you do","help","capabilities")) return {type:"say", text:"I can chat naturally, control light and fan, report temperature, humidity and people count, tell jokes, do quick math, and summarize usage with energy estimates."};
  if(any("thank you","thanks")) return {type:"say", text: pick(["Anytime!","You're welcome.","Happy to help."])};
  if(any("good morning","good afternoon","good evening","good night")){
    const m=s.match(/good (morning|afternoon|evening|night)/i);
    return {type:"say", text:`Good ${m?m[1]:"day"}, Achal.`};
  }
  if(any("tell me a joke","joke","make me laugh")) return {type:"say", text: pick(JOKES)};
  if(any("fun fact","tell me a fact","fact")) return {type:"say", text: pick(FACTS)};
  const mathAns=tryMath(s); if(mathAns) return {type:"say", text: mathAns};

  // Info
  if(any("what is the time","what's the time","whats the time","time now","tell time","time")) return {type:"time"};
  if(any("temperature","temp","how hot")) return {type:"temp"};
  if(any("humidity","how humid")) return {type:"hum"};
  if(any("how many people","people inside","people count","people")) return {type:"people"};

  // Device control
  if( (s.includes("light")&&s.includes("on")) || any("turn on light","switch on light","light on","turn the light on") ){ if(!s.includes("off")) return {type:"light",val:1}; }
  if( (s.includes("light")&&s.includes("off"))|| any("turn off light","switch off light","light off","turn the light off") ) return {type:"light",val:0};
  if( (s.includes("fan")&&s.includes("on"))   || any("turn on fan","switch on fan","fan on","turn the fan on") ){ if(!s.includes("off")) return {type:"fan",val:1}; }
  if( (s.includes("fan")&&s.includes("off"))  || any("turn off fan","switch off fan","fan off","turn the fan off") ) return {type:"fan",val:0};

  // Reports
  if(any("report","summary","status")) return {type:"report"};

  if(any("stop","exit","quit")) return {type:"stop"};
  return {type:"say", text: naturalReply(s)};
}

/* ---------- Actions ---------- */
function setDevice(dev,val){
  if(dev==='light'){ if(val && !cache.light){ counters.light_on_events++; startRun('light'); } if(!val && cache.light){ finishRun('light'); } }
  if(dev==='fan'){   if(val && !cache.fan){   counters.fan_on_events++;   startRun('fan'); } if(!val && cache.fan){   finishRun('fan'); } }
  cache[dev]=val?1:0; counters.cmds++; refreshTiles();
  return val?`Turning on the ${dev}.`:`Turning the ${dev} off.`;
}
function report(){
  const u=usage();
  return [
    "Here‚Äôs the room status.",
    `Light ${cache.light?'on':'off'} ‚Äî ${counters.light_on_events} times, ${fmtMs(u.lms)} total.`,
    `Fan ${cache.fan?'on':'off'} ‚Äî ${counters.fan_on_events} times, ${fmtMs(u.fms)} total.`,
    `People ${cache.people} (entries +${counters.people_entries}).`,
    `Temperature ${cache.temp.toFixed(1)}¬∞C, humidity ${cache.hum.toFixed(1)}%.`,
    `Energy about ${u.tk.toFixed(3)} kWh (‚Çπ${u.cost.toFixed(2)}).`
  ].join(" ");
}
async function handleIntent(res, raw){
  switch(res.type){
    case "idle": return;
    case "say": remember(raw,res.text); return speak(res.text);
    case "time": { const t=new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); const msg=`It's ${t}.`; remember(raw,msg); return speak(msg); }
    case "temp": { const msg=`Temperature is ${cache.temp.toFixed(1)} degrees Celsius.`; remember(raw,msg); return speak(msg); }
    case "hum":  { const msg=`Humidity is ${cache.hum.toFixed(1)} percent.`; remember(raw,msg); return speak(msg); }
    case "people": { const msg=`People in room: ${cache.people}.`; remember(raw,msg); return speak(msg); }
    case "light": { const msg=setDevice("light",res.val); remember(raw,msg); return speak(msg); }
    case "fan":   { const msg=setDevice("fan",res.val);   remember(raw,msg); return speak(msg); }
    case "report":{ const msg=report(); remember(raw,msg); return speak(msg); }
    case "stop": listening=false; try{ rec&&rec.stop(); }catch{}; return speak("Okay, I‚Äôll be quiet now.");
  }
}

/* ---------- STT (Always-on) with TTS guard + barge-in ---------- */
function getRecognizer(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert("Your browser doesn't support SpeechRecognition. Use Chrome on Android with HTTPS."); return null; }
  const r=new SR(); r.lang='en-IN'; r.continuous=true; r.interimResults=false; r.maxAlternatives=1;
  r.onstart=()=>{ setStatus("Listening‚Ä¶",true); micBtn.classList.add('live'); };
  r.onend  =()=>{ setStatus("Idle",false); micBtn.classList.remove('live'); if(listening && !ttsActive){ try{ r.start(); }catch{} } };
  r.onerror=e=>{ log("STT error: "+(e.error||'unknown')); };
    r.onresult = async e => {
    // If Astra is speaking, ignore interim speech (prevents 'silent' bug)
    if (ttsActive) return;

    const t = e.results[e.resultIndex][0].transcript.trim();
    if (!t || t === lastProcessed) return;

    lastProcessed = t;
    log("You: " + t);

    const res = intent(t);
    await handleIntent(res, t);
  };

  return r;
}
function startListening(){ if(listening) return; initVoice(); const r=getRecognizer(); if(!r) return; rec=r; listening=true; try{ rec.start(); }catch{} }
function stopListening(){ listening=false; try{ rec&&rec.stop(); }catch{} }

/* ---------- Manual buttons ---------- */
document.getElementById('btnLightOn').onclick = ()=>handleIntent({type:"light",val:1}, "button: light on");
document.getElementById('btnLightOff').onclick= ()=>handleIntent({type:"light",val:0}, "button: light off");
document.getElementById('btnFanOn').onclick   = ()=>handleIntent({type:"fan",val:1}, "button: fan on");
document.getElementById('btnFanOff').onclick  = ()=>handleIntent({type:"fan",val:0}, "button: fan off");
document.getElementById('btnReport').onclick  = ()=>handleIntent({type:"report"}, "button: report");
const btnReset = document.getElementById('btnReset');
if(btnReset){
  btnReset.onclick=()=>{ finishRun('light'); finishRun('fan'); counters.cmds=0; counters.light_on_events=0; counters.fan_on_events=0; counters.light_ms=0; counters.fan_ms=0; counters.people_entries=0; refreshTiles(); speak("Done. I‚Äôve reset the counters."); };
}

/* ---------- Mic toggle ---------- */
micBtn.addEventListener('click', ()=> listening?stopListening():startListening());

/* ---------- First paint ---------- */
setTimeout(()=>{ refreshTiles(); initVoice(); speak("Hi Achal, I‚Äôm ready. You can say: how are you, tell me a joke, or turn the light on."); }, 350);
    // Keep TTS alive on some Android builds
setTimeout(()=>{ try { speechSynthesis.resume(); } catch {} }, 500);

</script>
</body>
</html>








