<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Astra ‚Äì ESB + Dashboard Tiles</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b1220;color:#e5e7eb}
  .wrap{max-width:680px;margin:0 auto;padding:18px}
  .card{background:#0f172a;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}
  h1{margin:0 0 6px;font-size:20px}
  .muted{color:#94a3b8;font-size:13px;margin:0 0 12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:6px 10px;font-size:12px;color:#94a3b8}

  .mic{display:block;width:120px;height:120px;margin:12px auto;border-radius:50%;border:none;
       background:radial-gradient(60% 60% at 50% 30%,rgba(14,165,233,.25),transparent);
       box-shadow:inset 0 0 0 2px rgba(14,165,233,.35),0 10px 30px rgba(14,165,233,.25);
       font-size:34px;color:#fff}
  .mic.live{box-shadow:inset 0 0 0 3px rgba(34,197,94,.6),0 10px 30px rgba(34,197,94,.35)}
  .status{display:flex;gap:8px;justify-content:center;color:#94a3b8;font-size:13px}
  .dot{width:10px;height:10px;border-radius:50%;background:#ef4444}.dot.ok{background:#22c55e}

  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .tile{background:#0b1220;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
  .tile h3{margin:0 0 6px;font-size:12px;color:#94a3b8}
  .tile p{margin:0;font-size:18px}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .btn{border:1px solid rgba(255,255,255,.2);background:#0b1220;color:#e5e7eb;border-radius:10px;padding:10px 12px}

  .log{height:220px;overflow:auto;background:#0b1220;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;margin-top:12px}
  .log p{margin:6px 0;font-size:13px}
</style>
</head>
<body>
  <audio id="ttsAudio" preload="auto"></audio>
<div class="wrap">
  <div class="card">
    <h1>ü§ñ Astra ‚Äî Emergency Stable Build + Dashboard</h1>
    <p class="muted">Always-on listening with TTS-mute (no feedback loop). Voice commands, manual controls, report, and live tiles (Temp, Humidity, People, Light, Fan, Commands).</p>

    <div class="row">
      <span class="pill">Mode: <b>Always-on</b></span>
      <span class="pill">Lang: <b>en-IN</b></span>
      <span class="pill">Simulator: <b>ON</b></span>
    </div>

    <button id="micBtn" class="mic" title="Start/Stop">üé§</button>
    <div class="status"><span id="dot" class="dot"></span><span id="status">Idle</span></div>

    <!-- ‚¨áÔ∏è NEW DASHBOARD TILES -->
    <div class="kpis">
      <div class="tile"><h3>Light</h3><p id="kLight">OFF</p></div>
      <div class="tile"><h3>Fan</h3><p id="kFan">OFF</p></div>
      <div class="tile"><h3>People</h3><p id="kPeople">1</p></div>
      <div class="tile"><h3>Temp (¬∞C)</h3><p id="kTemp">27.0</p></div>
      <div class="tile"><h3>Humidity (%)</h3><p id="kHum">48.0</p></div>
      <div class="tile"><h3>Commands</h3><p id="kCmds">0</p></div>
    </div>

    <!-- Manual controls you already had -->
    <div class="grid">
      <button class="btn" id="btnLightOn">Light ON</button>
      <button class="btn" id="btnLightOff">Light OFF</button>
      <button class="btn" id="btnFanOn">Fan ON</button>
      <button class="btn" id="btnFanOff">Fan OFF</button>
      <button class="btn" id="btnReport">Speak Report</button>
      <button class="btn" id="btnReset">Reset Counters</button>
    </div>

    <div id="log" class="log" aria-live="polite"></div>
    <p class="muted">Say: ‚Äúturn the light on‚Äù, ‚Äúturn off the fan‚Äù, ‚Äúwhat‚Äôs the time‚Äù, ‚Äútemperature‚Äù, ‚Äúhumidity‚Äù, ‚Äúpeople‚Äù, ‚Äúreport‚Äù, ‚Äústop‚Äù.</p>
  </div>
</div>
  <script>
/* === ASTRA: Stable & Human-like AI Voice Assistant (Final Version) === */

let listening = false, rec = null, ttsActive = false, lastProcessed = "";
const logBox = document.getElementById('log');
const dot = document.getElementById('dot');
const statusEl = document.getElementById('status');
const micBtn = document.getElementById('micBtn');
const ttsAudio = document.getElementById('ttsAudio');

const counters = {cmds:0, light_on_events:0, fan_on_events:0, light_ms:0, fan_ms:0, people_entries:0};
let cache = {light:0, fan:0, temp:27.0, hum:48.0, people:1};
let _lightOnAt = null, _fanOnAt = null;

const LIGHT_WATTS = 12, FAN_WATTS = 75, INR_PER_KWH = 8;

// Dashboard
const kLight=document.getElementById('kLight');
const kFan=document.getElementById('kFan');
const kPeople=document.getElementById('kPeople');
const kTemp=document.getElementById('kTemp');
const kHum=document.getElementById('kHum');
const kCmds=document.getElementById('kCmds');

function refreshTiles(){
  kLight.textContent = cache.light ? "ON" : "OFF";
  kFan.textContent = cache.fan ? "ON" : "OFF";
  kPeople.textContent = cache.people;
  kTemp.textContent = cache.temp.toFixed(1);
  kHum.textContent = cache.hum.toFixed(1);
  kCmds.textContent = counters.cmds;
}

// Voice setup
let preferredVoice = null;
function pickBestVoice(){
  const voices = window.speechSynthesis.getVoices() || [];
  const want = [
    "Google UK English Female",
    "Google US English",
    "Google US English Female",
    "Microsoft Zira Desktop - English (United States)"
  ];
  const best = voices.find(v => want.includes(v.name)) ||
               voices.find(v => /Google/i.test(v.name) && /English/i.test(v.lang)) ||
               voices[0];
  return best || voices[0];
}
function initVoice(){
  preferredVoice = pickBestVoice();
}
speechSynthesis.onvoiceschanged = ()=> initVoice();

// Utility
function setStatus(t, ok){ statusEl.textContent=t; dot.classList.toggle('ok', !!ok); }
function log(t){ const p=document.createElement('p'); p.textContent=t; logBox.appendChild(p); logBox.scrollTop=logBox.scrollHeight; }

function humanize(text){
  let s = text
    .replace(/\bis not\b/gi, "isn't")
    .replace(/\bI am\b/gi, "I'm")
    .replace(/\bdo not\b/gi, "don't")
    .replace(/\bwe will\b/gi, "we'll");
  s = s.replace(/, /g, ", ‚Ä¶ ");
  if (!/[.!?]$/.test(s)) s += ".";
  s = s.charAt(0).toUpperCase() + s.slice(1);
  return s;
}

function thinkPause(){
  return new Promise(res=>{
    setStatus("Thinking‚Ä¶", false);
    setTimeout(()=>res(), 300 + Math.random()*500);
  });
}

// Split long text into safe chunks
function splitIntoChunks(s){
  return s.replace(/\s+/g,' ').trim()
          .split(/(?<=[.!?])\s+|,\s+/)
          .filter(Boolean)
          .slice(0,10);
}

// === SPEAK FUNCTION ===
async function speak(text){
  if (ttsActive) {
    console.warn("‚ö†Ô∏è Astra already speaking ‚Äî skipping new speech");
    return;
  }

  try { if (speechSynthesis.speaking) speechSynthesis.cancel(); } catch(e) { console.warn(e); }
  if (!ttsAudio.paused) { ttsAudio.pause(); ttsAudio.currentTime = 0; }

  await thinkPause();
  ttsActive = true;
  try { rec && rec.stop(); } catch {}

  const chunks = splitIntoChunks(humanize(text));
  const all = speechSynthesis.getVoices() || [];
  const want = ["Google UK English Female","Google US English","Google US English Female","Microsoft Zira Desktop - English (United States)"];
  const best = all.find(v => want.includes(v.name)) || preferredVoice || all[0];

  const sayChunk = (c) => new Promise(res=>{
    const u = new SpeechSynthesisUtterance(c);
    if (best){ u.voice = best; u.lang = best.lang; }
    u.rate = 0.96 + Math.random()*0.05;
    u.pitch = 1.0 + Math.random()*0.05;
    u.onend = ()=> setTimeout(res, 180);
    speechSynthesis.speak(u);
  });

  for (const c of chunks){
    if (!ttsActive) return;
    log("Astra: "+c);
    await sayChunk(c);
  }

  ttsActive = false;
  setStatus("Listening‚Ä¶", true);
  setTimeout(()=>{ if(listening && rec){ try{ rec.start(); }catch{} } }, 1000);
}

// Simulated data updater
setInterval(()=>{
  cache.temp=Math.max(20,Math.min(35,cache.temp+(Math.random()*0.4-0.2)));
  cache.hum =Math.max(30,Math.min(70,cache.hum +(Math.random()*0.8-0.4)));
  if(Math.random()<0.25){
    const before=cache.people;
    cache.people=Math.max(0,before+(Math.random()<0.5?-1:1));
    if(cache.people>before) counters.people_entries+=(cache.people-before);
  }
  refreshTiles();
},1200);

// Energy usage helpers
const nowMs=()=>performance.now();
const kwh=(ms,w)=>(ms/3600000)*(w/1000);
function startRun(what){ const t=nowMs(); if(what==='light'&&_lightOnAt==null)_lightOnAt=t; if(what==='fan'&&_fanOnAt==null)_fanOnAt=t; }
function finishRun(what){ const t=nowMs(); if(what==='light'&&_lightOnAt!=null){ counters.light_ms+=t-_lightOnAt; _lightOnAt=null; }
                          if(what==='fan'  &&_fanOnAt  !=null){ counters.fan_ms  +=t-_fanOnAt;   _fanOnAt  =null; } }
const fmtMs=ms=>{const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000); return (h?`${h}h `:"")+`${m}m`;};
function usage(){ const t=nowMs(); const lms=counters.light_ms+(_lightOnAt? t-_lightOnAt:0); const fms=counters.fan_ms+(_fanOnAt? t-_fanOnAt:0);
  const lk=kwh(lms,LIGHT_WATTS), fk=kwh(fms,FAN_WATTS), tk=lk+fk, cost=tk*INR_PER_KWH; return {lms,fms,lk,fk,tk,cost}; }

// Core brain (simplified for stability)
function intent(s){
  s = (s||"").toLowerCase();
  if(!s) return {type:"idle"};
  if(s.includes("light on")) return {type:"light",val:1};
  if(s.includes("light off")) return {type:"light",val:0};
  if(s.includes("fan on")) return {type:"fan",val:1};
  if(s.includes("fan off")) return {type:"fan",val:0};
  if(s.includes("report")) return {type:"report"};
  if(s.includes("temperature")||s.includes("temp")) return {type:"temp"};
  if(s.includes("humidity")) return {type:"hum"};
  if(s.includes("how are you")) return {type:"say", text:"I'm feeling great and ready to help, Achal."};
  if(s.includes("your name")) return {type:"say", text:"I'm Astra, your voice assistant."};
  if(s.includes("joke")) return {type:"say", text:"Why did the computer get cold? It left its Windows open!"};
  return {type:"say", text:"Got it!"};
}

function setDevice(dev,val){
  if(dev==='light'){ if(val && !cache.light){ counters.light_on_events++; startRun('light'); }
                     if(!val && cache.light){ finishRun('light'); } }
  if(dev==='fan'){   if(val && !cache.fan){ counters.fan_on_events++; startRun('fan'); }
                     if(!val && cache.fan){ finishRun('fan'); } }
  cache[dev]=val?1:0;
  counters.cmds++;
  refreshTiles();
  return val?`Turning on the ${dev}.`:`Turning off the ${dev}.`;
}

function report(){
  const u=usage();
  return [
    "Here‚Äôs the room status.",
    `Light ${cache.light?'on':'off'} ‚Äî ${counters.light_on_events} times, ${fmtMs(u.lms)} total.`,
    `Fan ${cache.fan?'on':'off'} ‚Äî ${counters.fan_on_events} times, ${fmtMs(u.fms)} total.`,
    `People in room: ${cache.people}.`,
    `Temperature ${cache.temp.toFixed(1)}¬∞C, humidity ${cache.hum.toFixed(1)}%.`,
    `Energy usage ${u.tk.toFixed(3)} kilowatt hours (‚Çπ${u.cost.toFixed(2)}).`
  ].join(" ");
}

async function handleIntent(res){
  switch(res.type){
    case "say": return speak(res.text);
    case "light": return speak(setDevice("light",res.val));
    case "fan": return speak(setDevice("fan",res.val));
    case "temp": return speak(`Temperature is ${cache.temp.toFixed(1)}¬∞C.`);
    case "hum": return speak(`Humidity is ${cache.hum.toFixed(1)}%.`);
    case "report": return speak(report());
  }
}

// Speech Recognition
function getRecognizer(){
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert("SpeechRecognition not supported. Use Chrome on Android."); return null; }
  const r = new SR(); r.lang='en-IN'; r.continuous=true; r.interimResults=false;
  r.onstart=()=>{ setStatus("Listening‚Ä¶",true); micBtn.classList.add('live'); };
  r.onend=()=>{ setStatus("Idle",false); micBtn.classList.remove('live'); if(listening && !ttsActive){ try{ r.start(); }catch{} } };
  r.onerror=e=>{ log("STT error: "+(e.error||'unknown')); };
  r.onresult=async e=>{
    if(ttsActive) return;
    const t = e.results[e.resultIndex][0].transcript.trim();
    if(!t || t===lastProcessed) return;
    lastProcessed = t;
    log("You: "+t);
    await handleIntent(intent(t));
  };
  return r;
}

function startListening(){ if(listening) return; initVoice(); const r=getRecognizer(); if(!r) return; rec=r; listening=true; speechSynthesis.cancel(); try{ rec.start(); }catch{} }
function stopListening(){ listening=false; try{ rec&&rec.stop(); }catch{} }

// Buttons
document.getElementById('btnLightOn').onclick = ()=>handleIntent({type:"light",val:1});
document.getElementById('btnLightOff').onclick = ()=>handleIntent({type:"light",val:0});
document.getElementById('btnFanOn').onclick = ()=>handleIntent({type:"fan",val:1});
document.getElementById('btnFanOff').onclick = ()=>handleIntent({type:"fan",val:0});
document.getElementById('btnReport').onclick = ()=>handleIntent({type:"report"});
document.getElementById('btnReset').onclick = ()=>{
  finishRun('light');
  finishRun('fan');
  counters.cmds = 0;
  counters.light_on_events = 0;
  counters.fan_on_events = 0;
  counters.light_ms = 0;
  counters.fan_ms = 0;
  counters.people_entries = 0;
  refreshTiles();
  speak("All counters have been reset, Achal.");
};

// Mic toggle
micBtn.addEventListener('click', ()=> listening ? stopListening() : startListening());

// Wait for Chrome voices to fully load before greeting
window.speechSynthesis.onvoiceschanged = () => {
  initVoice();
  setTimeout(()=>{
    refreshTiles();
    speak("Hi Achal, Astra is ready. Say 'turn on the light' or 'report'.");
  }, 600);
};

// Startup
setTimeout(()=>{ refreshTiles(); initVoice(); speak("Hi Achal, Astra is ready. Say 'turn on the light' or 'report'."); }, 350);
</script>
</body>
</html>






